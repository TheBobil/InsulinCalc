<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --green:   #2ecc87;
            --green2:  #1aaf6c;
            --dark:    #1a2e25;
            --card:    #ffffff;
            --bg:      #f0faf5;
            --border:  #ceeede;
            --text:    #1a2e25;
            --muted:   #6b9e82;
            --red:     #e74c3c;
            --amber:   #f39c12;
            --shadow:  0 4px 24px rgba(46,204,135,0.13);
        }

```
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Nunito', sans-serif;
        background: var(--bg);
        min-height: 100vh;
        color: var(--text);
    }

    /* â”€â”€ Header â”€â”€ */
    .app-header {
        background: var(--dark);
        padding: 20px 20px 0;
        position: sticky; top: 0; z-index: 100;
    }

    .app-title {
        color: var(--green);
        font-size: 28px;
        font-weight: 900;
        letter-spacing: -0.5px;
    }

    .app-subtitle {
        color: rgba(255,255,255,0.5);
        font-size: 13px;
        font-weight: 600;
        margin-top: 2px;
    }

    /* Tab bar */
    .tab-bar {
        display: flex;
        margin-top: 18px;
        gap: 4px;
    }

    .tab-btn {
        flex: 1;
        padding: 12px 8px;
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.45);
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn.active {
        color: var(--green);
        border-bottom-color: var(--green);
    }

    /* â”€â”€ Views â”€â”€ */
    .view { display: none; padding: 20px; }
    .view.active { display: block; }

    /* â”€â”€ Carb Total Banner â”€â”€ */
    .carb-banner {
        background: var(--dark);
        border-radius: 20px;
        padding: 22px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        box-shadow: var(--shadow);
    }

    .carb-banner-label {
        color: rgba(255,255,255,0.6);
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .carb-banner-value {
        color: var(--green);
        font-size: 52px;
        font-weight: 900;
        line-height: 1;
        margin-top: 4px;
    }

    .carb-banner-unit {
        color: rgba(255,255,255,0.5);
        font-size: 16px;
        font-weight: 700;
    }

    .carb-banner-right { text-align: right; }

    .meal-name-input {
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.15);
        border-radius: 12px;
        padding: 10px 14px;
        color: white;
        font-family: 'Nunito', sans-serif;
        font-size: 16px;
        font-weight: 700;
        width: 100%;
        margin-top: 14px;
    }

    .meal-name-input::placeholder { color: rgba(255,255,255,0.35); }
    .meal-name-input:focus { outline: none; border-color: var(--green); }

    /* â”€â”€ Big Action Buttons â”€â”€ */
    .action-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }

    .action-btn {
        padding: 22px 16px;
        border: none;
        border-radius: 18px;
        font-family: 'Nunito', sans-serif;
        font-size: 17px;
        font-weight: 800;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: transform 0.15s, box-shadow 0.15s;
        box-shadow: var(--shadow);
    }

    .action-btn:active { transform: scale(0.96); }

    .action-btn .btn-icon { font-size: 32px; }

    .btn-scan {
        background: var(--green);
        color: var(--dark);
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: center;
        gap: 14px;
        padding: 26px;
        font-size: 20px;
    }

    .btn-scan .btn-icon { font-size: 36px; }

    .btn-save {
        background: var(--dark);
        color: var(--green);
    }

    .btn-clear {
        background: white;
        color: var(--red);
        border: 2px solid #fce4e1;
    }

    /* Search toggle */
    .search-toggle-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
    }

    .search-toggle-btn {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 10px 16px;
        color: var(--muted);
        font-family: 'Nunito', sans-serif;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .search-toggle-btn.open {
        border-color: var(--green);
        color: var(--green2);
        background: #f0faf5;
    }

    .search-box {
        display: none;
        background: white;
        border: 2px solid var(--border);
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: var(--shadow);
    }

    .search-box.open { display: block; }

    .search-input-row { display: flex; gap: 8px; }

    .search-input {
        flex: 1;
        padding: 14px 16px;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-family: 'Nunito', sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
        background: var(--bg);
    }

    .search-input:focus { outline: none; border-color: var(--green); }

    .search-go-btn {
        padding: 14px 20px;
        background: var(--green);
        color: var(--dark);
        border: none;
        border-radius: 12px;
        font-family: 'Nunito', sans-serif;
        font-size: 15px;
        font-weight: 800;
        cursor: pointer;
    }

    .search-results { margin-top: 12px; max-height: 220px; overflow-y: auto; }

    .search-result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        border-radius: 12px;
        border: 2px solid var(--border);
        margin-bottom: 8px;
        cursor: pointer;
        background: var(--bg);
        transition: all 0.15s;
    }

    .search-result-item:hover, .search-result-item:active {
        border-color: var(--green);
        background: #e8f8f0;
    }

    .search-result-name { font-size: 14px; font-weight: 700; color: var(--text); }
    .search-result-brand { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .search-result-carbs { font-size: 15px; font-weight: 900; color: var(--green2); white-space: nowrap; margin-left: 10px; }

    .search-status { font-size: 13px; color: var(--muted); margin-top: 10px; font-weight: 600; }

    /* â”€â”€ Portion modal â”€â”€ */
    .portion-sheet {
        display: none;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: white;
        border-radius: 24px 24px 0 0;
        padding: 28px 24px 40px;
        box-shadow: 0 -8px 40px rgba(0,0,0,0.18);
        z-index: 500;
        animation: slideUp 0.25s ease-out;
    }

    .portion-sheet.open { display: block; }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .sheet-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 499;
    }

    .sheet-backdrop.open { display: block; }

    .sheet-handle {
        width: 44px; height: 5px;
        background: #ddd; border-radius: 3px;
        margin: 0 auto 20px;
    }

    .sheet-food-name {
        font-size: 20px;
        font-weight: 900;
        color: var(--text);
        margin-bottom: 4px;
    }

    .sheet-carbs-per100 {
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
        margin-bottom: 24px;
    }

    .portion-label {
        font-size: 15px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 10px;
    }

    .portion-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .portion-btn {
        width: 56px; height: 56px;
        border-radius: 50%;
        background: var(--dark);
        color: white;
        border: none;
        font-size: 28px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .portion-input {
        flex: 1;
        text-align: center;
        padding: 16px;
        border: 3px solid var(--green);
        border-radius: 14px;
        font-family: 'Nunito', sans-serif;
        font-size: 28px;
        font-weight: 900;
        color: var(--text);
    }

    .portion-input:focus { outline: none; }
    .portion-g-label { font-size: 18px; font-weight: 800; color: var(--muted); }

    .portion-carbs-preview {
        background: var(--bg);
        border-radius: 14px;
        padding: 16px;
        text-align: center;
        margin-bottom: 20px;
    }

    .portion-carbs-preview span {
        font-size: 36px;
        font-weight: 900;
        color: var(--green2);
    }

    .portion-carbs-preview p {
        font-size: 13px;
        color: var(--muted);
        font-weight: 600;
        margin-top: 2px;
    }

    .add-to-meal-btn {
        width: 100%;
        padding: 20px;
        background: var(--green);
        color: var(--dark);
        border: none;
        border-radius: 16px;
        font-family: 'Nunito', sans-serif;
        font-size: 20px;
        font-weight: 900;
        cursor: pointer;
        transition: transform 0.15s;
    }

    .add-to-meal-btn:active { transform: scale(0.97); }

    /* â”€â”€ Meal Items List â”€â”€ */
    .section-title {
        font-size: 13px;
        font-weight: 800;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 12px;
    }

    .meal-items-list { margin-bottom: 20px; }

    .meal-item {
        background: white;
        border-radius: 16px;
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .meal-item-info { flex: 1; }

    .meal-item-name {
        font-size: 16px;
        font-weight: 800;
        color: var(--text);
        line-height: 1.2;
    }

    .meal-item-portion {
        font-size: 13px;
        color: var(--muted);
        font-weight: 600;
        margin-top: 3px;
    }

    .meal-item-carbs {
        font-size: 22px;
        font-weight: 900;
        color: var(--green2);
        margin: 0 16px;
    }

    .meal-item-carbs span {
        font-size: 13px;
        font-weight: 700;
        color: var(--muted);
    }

    .remove-item-btn {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: #fce4e1;
        border: none;
        color: var(--red);
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .empty-meal {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
    }

    .empty-meal-icon { font-size: 56px; margin-bottom: 12px; }
    .empty-meal p { font-size: 16px; font-weight: 700; }
    .empty-meal small { font-size: 13px; font-weight: 600; opacity: 0.7; margin-top: 6px; display: block; }

    /* â”€â”€ Favourites View â”€â”€ */
    .favourites-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .fav-tile {
        background: white;
        border-radius: 20px;
        padding: 22px 16px;
        text-align: center;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s;
        position: relative;
        border: 3px solid transparent;
        animation: fadeIn 0.2s ease-out;
    }

    .fav-tile:active { transform: scale(0.95); }

    .fav-tile-icon { font-size: 40px; margin-bottom: 10px; }

    .fav-tile-name {
        font-size: 16px;
        font-weight: 900;
        color: var(--text);
        line-height: 1.2;
        margin-bottom: 8px;
    }

    .fav-tile-carbs {
        font-size: 24px;
        font-weight: 900;
        color: var(--green2);
    }

    .fav-tile-carbs span {
        font-size: 13px;
        color: var(--muted);
        font-weight: 700;
    }

    .fav-tile-items {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        margin-top: 4px;
    }

    .fav-delete-btn {
        position: absolute;
        top: 10px; right: 10px;
        width: 28px; height: 28px;
        border-radius: 50%;
        background: #fce4e1;
        border: none;
        color: var(--red);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .no-favourites {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        color: var(--muted);
    }

    .no-favourites-icon { font-size: 64px; margin-bottom: 16px; }
    .no-favourites p { font-size: 18px; font-weight: 800; }
    .no-favourites small { font-size: 14px; font-weight: 600; opacity: 0.7; margin-top: 8px; display: block; }

    /* Load favourite confirmation */
    .load-fav-banner {
        background: var(--green);
        border-radius: 14px;
        padding: 14px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        display: none;
    }

    .load-fav-banner.show { display: flex; }

    .load-fav-text { font-size: 15px; font-weight: 800; color: var(--dark); }

    .load-fav-dismiss {
        background: rgba(0,0,0,0.15);
        border: none;
        color: var(--dark);
        font-size: 18px;
        width: 28px; height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
    }

    /* â”€â”€ Scanner Modal â”€â”€ */
    .scanner-modal {
        display: none; position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.93);
        z-index: 1000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .scanner-modal.open { display: flex; }

    .scanner-header { color: white; text-align: center; padding: 0 20px 20px; }
    .scanner-header h2 { font-size: 22px; font-weight: 900; }
    .scanner-header p { font-size: 14px; opacity: 0.55; margin-top: 6px; font-weight: 600; }

    .scanner-viewport {
        width: min(340px, 86vw);
        height: min(340px, 86vw);
        border-radius: 20px;
        overflow: hidden;
        background: #111;
        position: relative;
    }

    #scannerDiv { width: 100%; height: 100%; }

    /* Override html5-qrcode default UI */
    #scannerDiv video { width: 100% !important; height: 100% !important; object-fit: cover !important; }
    #scannerDiv img { display: none !important; }

    .scan-frame-overlay {
        position: absolute; inset: 0;
        display: flex; align-items: center; justify-content: center;
        pointer-events: none;
    }

    .scan-frame {
        width: 70%; height: 28%;
        border: 3px solid var(--green);
        border-radius: 10px;
        box-shadow: 0 0 0 2000px rgba(0,0,0,0.38);
        position: relative; overflow: hidden;
    }

    .scan-line {
        position: absolute; left: 0; right: 0; height: 2px;
        background: linear-gradient(90deg, transparent, var(--green), transparent);
        animation: scanLine 1.8s linear infinite;
    }

    @keyframes scanLine {
        0%   { top: 0; opacity: 1; }
        90%  { top: calc(100% - 2px); opacity: 1; }
        100% { top: calc(100% - 2px); opacity: 0; }
    }

    .scanner-status {
        color: rgba(255,255,255,0.75);
        font-size: 15px; font-weight: 700;
        text-align: center; margin-top: 20px;
        padding: 0 24px; min-height: 48px; line-height: 1.5;
    }

    .scanner-status.success { color: var(--green); }
    .scanner-status.error   { color: #e74c3c; }

    .scanner-close-btn {
        margin-top: 20px; padding: 14px 44px;
        background: rgba(255,255,255,0.1);
        color: white; border: 2px solid rgba(255,255,255,0.2);
        border-radius: 50px; font-family: 'Nunito', sans-serif;
        font-size: 16px; font-weight: 800; cursor: pointer;
    }

    /* Toast */
    .toast {
        position: fixed; bottom: 30px; left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--dark); color: white;
        padding: 14px 24px; border-radius: 50px;
        font-size: 15px; font-weight: 700;
        opacity: 0; pointer-events: none;
        transition: all 0.3s; z-index: 9999;
        white-space: nowrap;
    }

    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
```

</head>
<body>

<div class="app-header">
    <div class="app-title">ğŸ¥— Meal Planner</div>
    <div class="app-subtitle">Scan food, build your meal</div>
    <div class="tab-bar">
        <button class="tab-btn active" data-tab="builder">Build Meal</button>
        <button class="tab-btn" data-tab="favourites">â­ Favourites</button>
    </div>
</div>

<!-- â”€â”€ BUILD MEAL VIEW â”€â”€ -->

<div class="view active" id="view-builder">

```
<div style="height: 20px;"></div>

<!-- Carb total banner -->
<div class="carb-banner">
    <div>
        <div class="carb-banner-label">Total Carbs</div>
        <div class="carb-banner-value" id="totalCarbs">0</div>
        <div class="carb-banner-unit">grams</div>
    </div>
    <div class="carb-banner-right">
        <input class="meal-name-input" id="mealNameInput" type="text" placeholder="Meal name (e.g. Breakfast)â€¦" maxlength="30">
    </div>
</div>

<!-- Big scan button -->
<div class="action-row">
    <button class="action-btn btn-scan" id="openScannerBtn">
        <span class="btn-icon">ğŸ“·</span>
        Scan Barcode
    </button>
</div>

<!-- Hidden search toggle -->
<div class="search-toggle-row">
    <button class="search-toggle-btn" id="searchToggleBtn">
        ğŸ” Can't scan? Search by name
    </button>
</div>

<div class="search-box" id="searchBox">
    <div class="search-input-row">
        <input type="text" class="search-input" id="searchInput" placeholder="e.g. banana, brown riceâ€¦" autocomplete="off">
        <button class="search-go-btn" id="searchGoBtn">Go</button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="search-status" id="searchStatus"></div>
</div>

<!-- Load fav banner -->
<div class="load-fav-banner" id="loadFavBanner">
    <div class="load-fav-text" id="loadFavText">âœ… Loaded from favourites</div>
    <button class="load-fav-dismiss" id="loadFavDismiss">Ã—</button>
</div>

<!-- Current meal items -->
<div class="section-title">Items in this meal</div>
<div class="meal-items-list" id="mealItemsList">
    <div class="empty-meal">
        <div class="empty-meal-icon">ğŸ½ï¸</div>
        <p>No items yet</p>
        <small>Scan a barcode or search to add food</small>
    </div>
</div>

<!-- Save / Clear buttons -->
<div class="action-row">
    <button class="action-btn btn-save" id="saveFavBtn">
        <span class="btn-icon">â­</span>
        Save as Favourite
    </button>
    <button class="action-btn btn-clear" id="clearMealBtn">
        <span class="btn-icon">ğŸ—‘ï¸</span>
        Clear Meal
    </button>
</div>
```

</div>

<!-- â”€â”€ FAVOURITES VIEW â”€â”€ -->

<div class="view" id="view-favourites">
    <div style="height: 20px;"></div>
    <div class="section-title">Saved Meals</div>
    <div class="favourites-grid" id="favouritesGrid"></div>
</div>

<!-- â”€â”€ PORTION SHEET â”€â”€ -->

<div class="sheet-backdrop" id="sheetBackdrop"></div>
<div class="portion-sheet" id="portionSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-food-name" id="sheetFoodName">Food Name</div>
    <div class="sheet-carbs-per100" id="sheetCarbsPer100">â€“ g carbs per 100g</div>
    <div class="portion-label">How much? (grams)</div>
    <div class="portion-controls">
        <button class="portion-btn" id="portionMinus">âˆ’</button>
        <input type="number" class="portion-input" id="portionInput" value="100" min="1">
        <span class="portion-g-label">g</span>
        <button class="portion-btn" id="portionPlus">+</button>
    </div>
    <div class="portion-carbs-preview">
        <span id="portionCarbsPreview">0</span>g carbs
        <p id="portionCarbsNote">for this portion</p>
    </div>
    <button class="add-to-meal-btn" id="addToMealBtn">ï¼‹ Add to Meal</button>
</div>

<!-- â”€â”€ SCANNER MODAL â”€â”€ -->

<div class="scanner-modal" id="scannerModal">
    <div class="scanner-header">
        <h2>Scan Barcode</h2>
        <p>Point at the barcode on the packaging</p>
    </div>
    <div class="scanner-viewport">
        <div id="scannerDiv"></div>
        <div class="scan-frame-overlay">
            <div class="scan-frame">
                <div class="scan-line"></div>
            </div>
        </div>
    </div>
    <div class="scanner-status" id="scannerStatus">Initialising cameraâ€¦</div>
    <button class="scanner-close-btn" id="scannerCloseBtn">Cancel</button>
</div>

<!-- Toast -->

<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMeal = [];       // { name, carbs100g, portionG, totalCarbs }
let pendingFood  = null;    // food being portioned

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadFavourites() {
    try { return JSON.parse(localStorage.getItem('mealPlannerFavs') || '[]'); } catch(e) { return []; }
}
function saveFavourites(favs) {
    localStorage.setItem('mealPlannerFavs', JSON.stringify(favs));
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2400);
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('view-' + btn.dataset.tab).classList.add('active');
        if (btn.dataset.tab === 'favourites') renderFavourites();
    });
});

// â”€â”€ Meal rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMeal() {
    const list = document.getElementById('mealItemsList');
    const totalEl = document.getElementById('totalCarbs');

    if (!currentMeal.length) {
        list.innerHTML = `<div class="empty-meal">
            <div class="empty-meal-icon">ğŸ½ï¸</div>
            <p>No items yet</p>
            <small>Scan a barcode or search to add food</small>
        </div>`;
        totalEl.textContent = '0';
        return;
    }

    const total = currentMeal.reduce((s, i) => s + i.totalCarbs, 0);
    totalEl.textContent = total.toFixed(1);

    list.innerHTML = currentMeal.map((item, idx) => `
        <div class="meal-item">
            <div class="meal-item-info">
                <div class="meal-item-name">${esc(item.name)}</div>
                <div class="meal-item-portion">${item.portionG}g portion</div>
            </div>
            <div class="meal-item-carbs">${item.totalCarbs.toFixed(1)}<span>g carbs</span></div>
            <button class="remove-item-btn" data-idx="${idx}">âœ•</button>
        </div>
    `).join('');

    list.querySelectorAll('.remove-item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentMeal.splice(parseInt(btn.dataset.idx), 1);
            renderMeal();
        });
    });
}

// â”€â”€ Portion sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPortionSheet(food) {
    pendingFood = food;
    document.getElementById('sheetFoodName').textContent = food.name;
    document.getElementById('sheetCarbsPer100').textContent = `${food.carbs100g.toFixed(1)}g carbs per 100g`;
    document.getElementById('portionInput').value = 100;
    updatePortionPreview();
    document.getElementById('portionSheet').classList.add('open');
    document.getElementById('sheetBackdrop').classList.add('open');
}

function closePortionSheet() {
    document.getElementById('portionSheet').classList.remove('open');
    document.getElementById('sheetBackdrop').classList.remove('open');
    pendingFood = null;
}

function updatePortionPreview() {
    if (!pendingFood) return;
    const g = parseFloat(document.getElementById('portionInput').value) || 0;
    const carbs = ((pendingFood.carbs100g * g) / 100);
    document.getElementById('portionCarbsPreview').textContent = carbs.toFixed(1);
}

document.getElementById('portionInput').addEventListener('input', updatePortionPreview);
document.getElementById('portionMinus').addEventListener('click', () => {
    const inp = document.getElementById('portionInput');
    inp.value = Math.max(5, (parseFloat(inp.value) || 0) - 10);
    updatePortionPreview();
});
document.getElementById('portionPlus').addEventListener('click', () => {
    const inp = document.getElementById('portionInput');
    inp.value = (parseFloat(inp.value) || 0) + 10;
    updatePortionPreview();
});

document.getElementById('sheetBackdrop').addEventListener('click', closePortionSheet);

document.getElementById('addToMealBtn').addEventListener('click', () => {
    if (!pendingFood) return;
    const g = parseFloat(document.getElementById('portionInput').value) || 0;
    if (g <= 0) { showToast('Please enter a portion size'); return; }
    const totalCarbs = (pendingFood.carbs100g * g) / 100;
    currentMeal.push({ name: pendingFood.name, carbs100g: pendingFood.carbs100g, portionG: g, totalCarbs });
    closePortionSheet();
    renderMeal();
    showToast(`âœ… Added ${pendingFood.name}`);
});

// â”€â”€ Food lookup helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function pickFood(product) {
    const carbs = product.nutriments['carbohydrates_100g'];
    openPortionSheet({ name: product.product_name, carbs100g: carbs });
}

// â”€â”€ Barcode scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let html5Scanner = null;

async function openScanner() {
    const modal = document.getElementById('scannerModal');
    const statusEl = document.getElementById('scannerStatus');
    modal.classList.add('open');
    statusEl.className = 'scanner-status';
    statusEl.textContent = 'Initialising cameraâ€¦';

    try {
        html5Scanner = new Html5Qrcode('scannerDiv');
        await html5Scanner.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: { width: 240, height: 100 },
              formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,  Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128
              ]
            },
            async (code) => {
                statusEl.className = 'scanner-status success';
                statusEl.textContent = `Found barcode â€” looking upâ€¦`;
                await stopScanner();
                modal.classList.remove('open');
                await lookupBarcode(code);
            },
            () => {}
        );
        statusEl.textContent = 'Point camera at the barcodeâ€¦';
    } catch(e) {
        statusEl.className = 'scanner-status error';
        statusEl.textContent = e.name === 'NotAllowedError'
            ? 'Camera permission denied. Please allow access in your browser settings.'
            : 'Could not start camera: ' + (e.message || e);
    }
}

async function stopScanner() {
    if (html5Scanner) {
        try { if (html5Scanner.isScanning) await html5Scanner.stop(); } catch(e) {}
        try { html5Scanner.clear(); } catch(e) {}
        html5Scanner = null;
    }
}

async function closeScanner() {
    await stopScanner();
    document.getElementById('scannerModal').classList.remove('open');
}

document.getElementById('openScannerBtn').addEventListener('click', openScanner);
document.getElementById('scannerCloseBtn').addEventListener('click', () => closeScanner());

async function lookupBarcode(barcode) {
    showToast('Looking up productâ€¦');
    try {
        const r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        const d = await r.json();
        if (d.status !== 1 || !d.product) {
            showToast('Product not found â€” try searching by name'); return;
        }
        const p = d.product;
        if (!p.nutriments || typeof p.nutriments['carbohydrates_100g'] !== 'number') {
            showToast(`Found ${p.product_name} but no carb data`); return;
        }
        openPortionSheet({ name: p.product_name, carbs100g: p.nutriments['carbohydrates_100g'] });
    } catch(e) {
        showToast('Lookup failed â€” check your connection');
    }
}

// â”€â”€ Text search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('searchToggleBtn').addEventListener('click', () => {
    const box = document.getElementById('searchBox');
    const btn = document.getElementById('searchToggleBtn');
    const open = box.classList.toggle('open');
    btn.classList.toggle('open', open);
    if (open) document.getElementById('searchInput').focus();
});

async function doSearch() {
    const q = document.getElementById('searchInput').value.trim();
    if (!q) return;
    const status = document.getElementById('searchStatus');
    const results = document.getElementById('searchResults');
    status.textContent = 'Searchingâ€¦';
    results.innerHTML = '';
    try {
        const r = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&action=process&json=1&page_size=10&fields=product_name,brands,nutriments`);
        const d = await r.json();
        const products = (d.products || []).filter(p => p.product_name && p.nutriments && typeof p.nutriments['carbohydrates_100g'] === 'number');
        if (!products.length) { status.textContent = 'No results found â€” try a different term.'; return; }
        status.textContent = '';
        results.innerHTML = products.map((p, i) => {
            const brand = p.brands ? `<div class="search-result-brand">${esc(p.brands)}</div>` : '';
            return `<div class="search-result-item" data-idx="${i}">
                <div><div class="search-result-name">${esc(p.product_name)}</div>${brand}</div>
                <div class="search-result-carbs">${p.nutriments['carbohydrates_100g'].toFixed(1)}g<br><small style="font-size:11px;color:#6b9e82">per 100g</small></div>
            </div>`;
        }).join('');
        results.querySelectorAll('.search-result-item').forEach((el, i) => {
            el.addEventListener('click', () => {
                pickFood(products[i]);
                // close search
                document.getElementById('searchBox').classList.remove('open');
                document.getElementById('searchToggleBtn').classList.remove('open');
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('searchStatus').textContent = '';
                document.getElementById('searchInput').value = '';
            });
        });
    } catch(e) {
        status.textContent = 'Search failed â€” check your connection.';
    }
}

document.getElementById('searchGoBtn').addEventListener('click', doSearch);
document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') doSearch(); });

// â”€â”€ Save / Clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('saveFavBtn').addEventListener('click', () => {
    if (!currentMeal.length) { showToast('Add some food first!'); return; }
    const name = document.getElementById('mealNameInput').value.trim() || 'My Meal';
    const favs = loadFavourites();
    favs.unshift({
        id: Date.now(),
        name,
        items: [...currentMeal],
        totalCarbs: currentMeal.reduce((s,i) => s + i.totalCarbs, 0),
        savedAt: new Date().toISOString()
    });
    saveFavourites(favs);
    showToast(`â­ "${name}" saved!`);
});

document.getElementById('clearMealBtn').addEventListener('click', () => {
    if (!currentMeal.length) return;
    if (confirm('Clear all items from this meal?')) {
        currentMeal = [];
        document.getElementById('mealNameInput').value = '';
        renderMeal();
        document.getElementById('loadFavBanner').classList.remove('show');
    }
});

// â”€â”€ Favourites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MEAL_EMOJIS = ['ğŸ³','ğŸ¥£','ğŸ¥—','ğŸ','ğŸ²','ğŸ¥˜','ğŸ«•','ğŸ±','ğŸ«”','ğŸŒ®','ğŸ¥™','ğŸ¥ª'];

function renderFavourites() {
    const favs = loadFavourites();
    const grid = document.getElementById('favouritesGrid');

    if (!favs.length) {
        grid.innerHTML = `<div class="no-favourites">
            <div class="no-favourites-icon">â­</div>
            <p>No saved meals yet</p>
            <small>Build a meal and tap "Save as Favourite"</small>
        </div>`;
        return;
    }

    grid.innerHTML = favs.map((fav, i) => {
        const emoji = MEAL_EMOJIS[i % MEAL_EMOJIS.length];
        const itemCount = fav.items.length;
        return `<div class="fav-tile" data-id="${fav.id}">
            <button class="fav-delete-btn" data-id="${fav.id}">âœ•</button>
            <div class="fav-tile-icon">${emoji}</div>
            <div class="fav-tile-name">${esc(fav.name)}</div>
            <div class="fav-tile-carbs">${fav.totalCarbs.toFixed(1)}<span>g carbs</span></div>
            <div class="fav-tile-items">${itemCount} item${itemCount !== 1 ? 's' : ''}</div>
        </div>`;
    }).join('');

    // Load favourite
    grid.querySelectorAll('.fav-tile').forEach(tile => {
        tile.addEventListener('click', (e) => {
            if (e.target.classList.contains('fav-delete-btn')) return;
            const id = parseInt(tile.dataset.id);
            const fav = loadFavourites().find(f => f.id === id);
            if (!fav) return;
            currentMeal = [...fav.items];
            document.getElementById('mealNameInput').value = fav.name;
            renderMeal();
            // Switch to builder tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelector('[data-tab="builder"]').classList.add('active');
            document.getElementById('view-builder').classList.add('active');
            // Show loaded banner
            const banner = document.getElementById('loadFavBanner');
            document.getElementById('loadFavText').textContent = `âœ… Loaded "${fav.name}"`;
            banner.classList.add('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });

    // Delete favourite
    grid.querySelectorAll('.fav-delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('Remove this saved meal?')) {
                const id = parseInt(btn.dataset.id);
                saveFavourites(loadFavourites().filter(f => f.id !== id));
                renderFavourites();
            }
        });
    });
}

document.getElementById('loadFavDismiss').addEventListener('click', () => {
    document.getElementById('loadFavBanner').classList.remove('show');
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderMeal();
</script>

</body>
</html>